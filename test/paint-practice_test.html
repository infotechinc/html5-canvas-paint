<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, minimum-scale=1, initial-scale=1, user-scalable=yes">

    <title>paint-practice test</title>

    <script src="../node_modules/@webcomponents/webcomponentsjs/webcomponents-loader.js"></script>
    <script src="../node_modules/wct-browser-legacy/browser.js"></script>

    <script type="module" src="../paint-practice.js"></script>
    <script src='../demo/fabric.js'></script>
  </head>
  <body>

    <test-fixture id="BasicTestFixture">
      <template>
        <paint-practice></paint-practice>
      </template>
    </test-fixture>

    <test-fixture id="ChangedPropertyTestFixture">
      <template>
        <paint-practice></paint-practice>
      </template>
    </test-fixture>

    <script type="module">
      suite('paint-practice', () => {
        var el;
        var shadow;
        setup(function(){
           el = fixture('BasicTestFixture');
           shadow = el.shadowRoot;
          
        });

        test('adding a square to the canvas', (done) => {
          const alertStub = sinon.stub(window, 'alert').returns(true);
          assert.equal(el.canvas.size(), 0);
          const addSquareSpy = sinon.spy(el, 'addSquare');
          el.addSquare();
          sinon.assert.calledOnce(addSquareSpy);
          assert.equal(el.canvas.size(), 1);
          done();
        });

        test('deleting a square from the canvas', (done) => {
          assert.equal(el.canvas.size(), 0);
          el.addSquare();
          assert.equal(el.canvas.size(), 1);
          const deleteSquareSpy = sinon.spy(el, 'deleteSquare');
          el.deleteSquare();
          sinon.assert.calledOnce(deleteSquareSpy);
          assert.equal(el.canvas.size(), 0);
          done(); 
        });

         test('deleting from delete key listener', () => {
          assert.equal(el.canvas.size(), 0);
          el.addSquare();
          assert.equal(el.canvas.size(), 1);
          const dltKeySpy = sinon.spy(el, 'deleteListener');
          el.canvas.on('keydown', function(event){
          assert.equal(event.detail, 'delete');
          assert.equal(el.canvas.size(), 0);
          sinon.assert.calledOnce(dltKeySpy);
          });
          
          el.canvas.fire();

        });

        test('arrowSelector changes selected tool to arrow', ()=> {
          const arrowClickIcon = shadow.querySelector('#arrowSel');
          const addArrowSpy = sinon.spy(el, 'arrowSelector');
          arrowClickIcon.click();
          sinon.assert.calledOnce(addArrowSpy);
          assert(el.selectedTool == 'arrow');
        });

        test('rectSelector changes selected tool to rectangle', ()=> {
          const rectangleClickIcon = shadow.querySelector('#rectSel');
          const addRectangleSpy = sinon.spy(el, 'rectSelector');
          rectangleClickIcon.click();
          sinon.assert.calledOnce(addRectangleSpy);
          assert.equal(el.selectedTool, 'rectangle');
        });

        test('rectSelector changes selectedTool when called after arrowSelector ', ()=> {
          assert.equal(el.selectedTool, 'rectangle');
          const arrowClickIcon = shadow.querySelector('#arrowSel');
          const addArrowSpy = sinon.spy(el, 'arrowSelector');
          arrowClickIcon.click();
          sinon.assert.calledOnce(addArrowSpy);
          assert.equal(el.selectedTool, 'arrow');
          const rectangleClickIcon = shadow.querySelector('#rectSel');
          const addRectangleSpy = sinon.spy(el, 'rectSelector');
          rectangleClickIcon.click();
          sinon.assert.calledOnce(addRectangleSpy);
          assert.equal(el.selectedTool, 'rectangle');
        });

        test('switchSelection icon calls switchSelection method', ()=> {
          const switchClickIcon = shadow.querySelector('#switchSel');
          const switchSpy = sinon.spy(el, 'switchToolSelection');
          switchClickIcon.click();

          sinon.assert.calledOnce(switchSpy);
        });

        test('switchSelection icon sets canvas selection to true ', ()=> {
          const switchClickIcon = shadow.querySelector('#switchSel');
          const switchSpy = sinon.spy(el, 'switchToolSelection');
          switchClickIcon.click();
          assert.equal(el.canvas.selection, true);
          sinon.assert.calledOnce(switchSpy);
        });

        test('delete icon deletes shape from canvas', ()=> {
          assert.equal(el.canvas.size(), 0);
          const deleteClickIcon = shadow.querySelector('#delIcon');
          const deleteSpy = sinon.spy(el, 'deleteSquare');
          el.addSquare();
          assert.equal(el.canvas.size(), 1);
          deleteClickIcon.click();
          sinon.assert.calledOnce(deleteSpy);
          assert.equal(el.canvas.size() , 0);
        });

        test('when clicking on a square another square is not created', ()=> {
          assert.equal(el.canvas.size(), 0);
          el.addSquare();
          assert.equal(el.canvas.size(), 1);
          const shape = el.canvas.getActiveObject();
          shape.onSelect();
          assert.equal(el.canvas.size(), 1);
        });

        test.skip('rectangles can be added when selecting the rectangle icon after selecting the switchToolSelection icon', ()=> {

          assert.equal(el.canvas.size(), 0);
          const switchClickIcon = shadow.querySelector('#switchSel');
          const switchSpy = sinon.spy(el, 'switchToolSelection');
          switchClickIcon.click();
          //I want to do mouse down here and simulate the user dragging a square but I dont know how i'd do that
          const rectangleClickIcon = shadow.querySelector('#rectSel');
          const addRectangleSpy = sinon.spy(el, 'rectSelector');
          

        });


      });
    </script>

  </body>
</html>
